// Schema Prisma - Vigie Web
// Base de donnees PostgreSQL via Supabase

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// UTILISATEURS
// ============================================
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  avatarUrl       String?   @map("avatar_url")

  // Lien Stripe
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  plan                 Plan      @default(FREE)

  // Parametres de notification
  notifyEmail       Boolean   @default(true) @map("notify_email")
  notifyDiscord     Boolean   @default(false) @map("notify_discord")
  discordWebhookUrl String?   @map("discord_webhook_url")

  // Metadonnees
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  sites           Site[]
  alerts          Alert[]

  @@map("users")
}

enum Plan {
  FREE
  PRO
  AGENCY
}

// ============================================
// SITES SURVEILLES
// ============================================
model Site {
  id              String     @id @default(cuid())
  userId          String     @map("user_id")

  // Informations du site
  name            String
  url             String

  // Etat actuel
  isActive        Boolean    @default(true) @map("is_active")
  currentStatus   SiteStatus @default(UNKNOWN) @map("current_status")
  lastCheckedAt   DateTime?  @map("last_checked_at")

  // Infos SSL
  sslExpiresAt    DateTime?  @map("ssl_expires_at")
  sslIssuer       String?    @map("ssl_issuer")

  // Infos Domaine
  domainExpiresAt  DateTime?  @map("domain_expires_at")
  domainRegistrar  String?    @map("domain_registrar")

  // Statistiques calculees
  uptimePercentage Float?    @map("uptime_percentage")
  avgResponseTime  Int?      @map("avg_response_time")

  // Metadonnees
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  checks          Check[]
  alerts          Alert[]

  @@map("sites")
}

enum SiteStatus {
  UP
  DOWN
  DEGRADED
  UNKNOWN
}

// ============================================
// RESULTATS DES CHECKS
// ============================================
model Check {
  id              String     @id @default(cuid())
  siteId          String     @map("site_id")

  // Resultat du check
  status          SiteStatus
  statusCode      Int?       @map("status_code")
  responseTime    Int?       @map("response_time")
  errorMessage    String?    @map("error_message")

  // Type de check effectue
  checkType       CheckType  @map("check_type")

  // Metadonnees
  checkedAt       DateTime   @default(now()) @map("checked_at")

  // Relations
  site            Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId, checkedAt])
  @@map("checks")
}

enum CheckType {
  UPTIME
  SSL
  DOMAIN
  PERFORMANCE
}

// ============================================
// ALERTES
// ============================================
model Alert {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  siteId          String    @map("site_id")

  // Details de l'alerte
  type            AlertType
  severity        Severity
  title           String
  message         String

  // Etat de l'alerte
  isRead          Boolean   @default(false) @map("is_read")
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at")

  // Notifications envoyees
  emailSent       Boolean   @default(false) @map("email_sent")
  discordSent     Boolean   @default(false) @map("discord_sent")

  // Metadonnees
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  site            Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("alerts")
}

enum AlertType {
  SITE_DOWN
  SITE_UP
  SSL_EXPIRING
  SSL_EXPIRED
  DOMAIN_EXPIRING
  DOMAIN_EXPIRED
  SLOW_RESPONSE
  STATUS_CODE_ERROR
}

enum Severity {
  INFO
  WARNING
  CRITICAL
}
